<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
  <?!= include('stylesheet'); ?>
  <style>
    .csv-container {
      max-width: 900px;
      margin: 0 auto;
      padding: 2rem 1rem;
    }

    .csv-panel {
      background: var(--card-bg);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 2rem;
      margin-bottom: 1.5rem;
    }

    .csv-panel h2 {
      margin-bottom: 1rem;
      color: var(--dark-color);
    }

    .csv-panel p {
      color: var(--text-muted);
      margin-bottom: 1rem;
    }

    .drop-zone {
      border: 2px dashed var(--border-color);
      border-radius: var(--radius);
      padding: 3rem 2rem;
      text-align: center;
      transition: var(--transition);
      cursor: pointer;
    }

    .drop-zone:hover,
    .drop-zone.dragover {
      border-color: var(--primary-color);
      background-color: #f0f7ff;
    }

    .drop-zone-icon {
      font-size: 3rem;
      color: var(--text-muted);
      margin-bottom: 1rem;
    }

    .drop-zone-text {
      font-size: 1.1rem;
      color: var(--text-muted);
    }

    .drop-zone-text span {
      color: var(--primary-color);
      text-decoration: underline;
    }

    .csv-textarea {
      width: 100%;
      min-height: 200px;
      padding: 1rem;
      border: 1px solid var(--border-color);
      border-radius: var(--radius-sm);
      font-family: monospace;
      font-size: 0.9rem;
      resize: vertical;
    }

    .csv-preview {
      margin-top: 1.5rem;
      overflow-x: auto;
    }

    .csv-preview table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
    }

    .csv-preview th,
    .csv-preview td {
      padding: 0.5rem;
      border: 1px solid var(--border-color);
      text-align: left;
    }

    .csv-preview th {
      background: var(--light-color);
      font-weight: 500;
    }

    .csv-preview tr:nth-child(even) {
      background: #fafafa;
    }

    .csv-result {
      padding: 1.5rem;
      border-radius: var(--radius);
      margin-top: 1rem;
    }

    .csv-result.success {
      background: #d4edda;
      border: 1px solid #c3e6cb;
    }

    .csv-result.error {
      background: #f8d7da;
      border: 1px solid #f5c6cb;
    }

    .csv-result h4 {
      margin-bottom: 0.5rem;
    }

    .csv-result ul {
      margin: 0.5rem 0;
      padding-left: 1.5rem;
    }

    .csv-result li {
      margin-bottom: 0.25rem;
    }

    .template-section {
      background: #f8f9fa;
      padding: 1rem;
      border-radius: var(--radius-sm);
      margin-top: 1rem;
    }

    .template-section h4 {
      font-size: 0.95rem;
      margin-bottom: 0.5rem;
    }

    .template-section code {
      display: block;
      background: white;
      padding: 0.75rem;
      border-radius: var(--radius-sm);
      font-size: 0.8rem;
      overflow-x: auto;
      white-space: pre;
    }
  </style>
</head>
<body>
  <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
  <header class="header">
    <div class="header-content">
      <h1 class="header-title">CSVä¸€æ‹¬ç™»éŒ²</h1>
      <div class="header-actions">
        <a href="?mode=admin" class="btn btn-secondary">åç°¿ã«æˆ»ã‚‹</a>
      </div>
    </div>
  </header>

  <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
  <main class="csv-container">
    <!-- èª¬æ˜ -->
    <div class="csv-panel">
      <h2>CSVãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰é¸æ‰‹ã‚’ä¸€æ‹¬ç™»éŒ²</h2>
      <p>CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã‹ã€ä¸‹ã®ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã«ç›´æ¥è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚</p>

      <div class="template-section">
        <h4>CSVãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆï¼ˆå¿…é ˆåˆ—: name, registration_numberï¼‰</h4>
        <code>name,registration_number,affiliation,category,target_1500m,target_3000m,target_5000m,target_10000m,target_half,target_full,comment
å±±ç”°å¤ªéƒ,001,æ±äº¬é«˜æ ¡,é«˜æ ¡ç”Ÿ,4:10,9:00,15:30,32:00,,
ä½è—¤èŠ±å­,002,å¤§é˜ªå¤§å­¦,å¤§å­¦ç”Ÿ,4:30,9:30,16:00,33:00,1:15:00,</code>
      </div>
    </div>

    <!-- ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ -->
    <div class="csv-panel">
      <h2>ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</h2>
      <div class="drop-zone" id="dropZone" onclick="document.getElementById('fileInput').click()">
        <div class="drop-zone-icon">ğŸ“</div>
        <div class="drop-zone-text">
          CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—<br>
          ã¾ãŸã¯<span>ã‚¯ãƒªãƒƒã‚¯ã—ã¦é¸æŠ</span>
        </div>
      </div>
      <input type="file" id="fileInput" accept=".csv" style="display:none" onchange="handleFileSelect(event)">
    </div>

    <!-- ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ› -->
    <div class="csv-panel">
      <h2>ã¾ãŸã¯ã€CSVãƒ‡ãƒ¼ã‚¿ã‚’ç›´æ¥å…¥åŠ›</h2>
      <textarea class="csv-textarea" id="csvTextarea" placeholder="name,registration_number,affiliation,category&#10;å±±ç”°å¤ªéƒ,001,æ±äº¬é«˜æ ¡,é«˜æ ¡ç”Ÿ"></textarea>

      <div style="margin-top:1rem;display:flex;gap:0.75rem;">
        <button class="btn btn-outline" onclick="previewCSV()">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</button>
        <button class="btn btn-primary" onclick="importCSV()">ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Ÿè¡Œ</button>
      </div>

      <!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ -->
      <div class="csv-preview" id="csvPreview" style="display:none;">
        <h4>ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h4>
        <div id="previewTable"></div>
      </div>

      <!-- çµæœè¡¨ç¤º -->
      <div id="importResult"></div>
    </div>
  </main>

  <!-- ãƒˆãƒ¼ã‚¹ãƒˆ -->
  <div class="toast-container" id="toastContainer"></div>

  <script>
    // ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—
    const dropZone = document.getElementById('dropZone');

    dropZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropZone.classList.add('dragover');
    });

    dropZone.addEventListener('dragleave', () => {
      dropZone.classList.remove('dragover');
    });

    dropZone.addEventListener('drop', (e) => {
      e.preventDefault();
      dropZone.classList.remove('dragover');

      const files = e.dataTransfer.files;
      if (files.length > 0) {
        readFile(files[0]);
      }
    });

    function handleFileSelect(event) {
      const file = event.target.files[0];
      if (file) {
        readFile(file);
      }
    }

    function readFile(file) {
      if (!file.name.endsWith('.csv')) {
        showToast('CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„', 'error');
        return;
      }

      const reader = new FileReader();
      reader.onload = function(e) {
        document.getElementById('csvTextarea').value = e.target.result;
        previewCSV();
      };
      reader.readAsText(file, 'UTF-8');
    }

    function previewCSV() {
      const csvContent = document.getElementById('csvTextarea').value.trim();

      if (!csvContent) {
        showToast('CSVãƒ‡ãƒ¼ã‚¿ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
        return;
      }

      const lines = csvContent.split('\n').filter(line => line.trim());
      if (lines.length < 2) {
        showToast('ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã¨ãƒ‡ãƒ¼ã‚¿è¡ŒãŒå¿…è¦ã§ã™', 'error');
        return;
      }

      const headers = parseCSVLine(lines[0]);
      const previewData = lines.slice(1, 6).map(line => parseCSVLine(line)); // æœ€å¤§5è¡Œ

      let tableHTML = '<table><thead><tr>';
      headers.forEach(h => {
        tableHTML += `<th>${h}</th>`;
      });
      tableHTML += '</tr></thead><tbody>';

      previewData.forEach(row => {
        tableHTML += '<tr>';
        row.forEach(cell => {
          tableHTML += `<td>${cell}</td>`;
        });
        tableHTML += '</tr>';
      });

      if (lines.length > 6) {
        tableHTML += `<tr><td colspan="${headers.length}" style="text-align:center;color:var(--text-muted);">... ä»– ${lines.length - 6} è¡Œ</td></tr>`;
      }

      tableHTML += '</tbody></table>';

      document.getElementById('previewTable').innerHTML = tableHTML;
      document.getElementById('csvPreview').style.display = 'block';
    }

    function parseCSVLine(line) {
      const result = [];
      let current = '';
      let inQuotes = false;

      for (let i = 0; i < line.length; i++) {
        const char = line[i];

        if (char === '"') {
          if (inQuotes && line[i + 1] === '"') {
            current += '"';
            i++;
          } else {
            inQuotes = !inQuotes;
          }
        } else if (char === ',' && !inQuotes) {
          result.push(current.trim());
          current = '';
        } else {
          current += char;
        }
      }

      result.push(current.trim());
      return result;
    }

    function importCSV() {
      const csvContent = document.getElementById('csvTextarea').value.trim();

      if (!csvContent) {
        showToast('CSVãƒ‡ãƒ¼ã‚¿ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
        return;
      }

      // ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
      const btn = event.target;
      btn.disabled = true;
      btn.textContent = 'ã‚¤ãƒ³ãƒãƒ¼ãƒˆä¸­...';

      google.script.run
        .withSuccessHandler(function(result) {
          btn.disabled = false;
          btn.textContent = 'ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Ÿè¡Œ';

          if (result.success) {
            const data = result.data;
            let html = `<div class="csv-result success">
              <h4>ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Œäº†</h4>
              <p>ç™»éŒ²æˆåŠŸ: ${data.imported}ä»¶ / ã‚¹ã‚­ãƒƒãƒ—: ${data.skipped}ä»¶</p>`;

            if (data.errors && data.errors.length > 0) {
              html += '<ul>';
              data.errors.slice(0, 10).forEach(err => {
                html += `<li>${err}</li>`;
              });
              if (data.errors.length > 10) {
                html += `<li>... ä»– ${data.errors.length - 10} ä»¶ã®ã‚¨ãƒ©ãƒ¼</li>`;
              }
              html += '</ul>';
            }

            html += '</div>';
            document.getElementById('importResult').innerHTML = html;
            showToast(`${data.imported}ä»¶ã®é¸æ‰‹ã‚’ç™»éŒ²ã—ã¾ã—ãŸ`, 'success');
          } else {
            document.getElementById('importResult').innerHTML =
              `<div class="csv-result error"><h4>ã‚¨ãƒ©ãƒ¼</h4><p>${result.error}</p></div>`;
            showToast(result.error || 'ã‚¤ãƒ³ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
          }
        })
        .withFailureHandler(function(error) {
          btn.disabled = false;
          btn.textContent = 'ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Ÿè¡Œ';
          showToast('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message, 'error');
        })
        .importPlayersFromCSV(csvContent);
    }

    function showToast(message, type) {
      const container = document.getElementById('toastContainer');
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.textContent = message;
      container.appendChild(toast);
      setTimeout(() => toast.remove(), 4000);
    }
  </script>
</body>
</html>
