# 縦断駅伝選手名簿 管理システム 仕様書（Ver2.0）

## 1. 文書情報

| 項目 | 内容 |
|------|------|
| 文書名 | 縦断駅伝選手名簿 管理システム 仕様書 |
| 作成日 | 2025-11-30 |
| 作成者 | 仁部（担当者名） |
| バージョン | Ver2.0（完全版：基本機能＋戦略機能＋権限分離＋登録番号対応） |

---

## 2. システム概要

### 基本情報

| 項目 | 内容 |
|------|------|
| システム名 | 縦断駅伝選手名簿 管理システム |
| プラットフォーム | Google Apps Script (GAS) Web Application |

### 開発目的

| 目的 | 説明 |
|------|------|
| 一元管理 | 選手情報・大会記録・チーム記録をスプレッドシートで一元化する |
| 閲覧性 | ブラウザから直感的に閲覧・検索できるUIを提供し、スマホ・PC問わずアクセス可能にする |
| チーム強化 | 記録の可視化（グラフ）と区間配置シミュレーションにより、戦略的なチーム作りを支援する |
| 事務効率化 | CSV一括登録などにより、管理者の作業負担を軽減する |

### 利用者ターゲット

| ユーザー種別 | 役割 |
|-------------|------|
| 管理者（コーチ・監督・スタッフ） | チーム運営、戦略立案、データ管理を行う |
| 一般ユーザー（選手・保護者） | 自身の記録確認、目標設定、モチベーション維持 |

---

## 3. システム構成

> **設計思想**: 「データベース1つに対して、入り口（アプリ）を2つ用意する」構成を採用

### 構成図

```
┌─────────────────────────────────────────────────────────┐
│                  Google スプレッドシート                  │
│                    （単一ファイル）                       │
│              ┌─────────┬─────────┬─────────┐            │
│              │ Players │ Records │  Team   │            │
│              │         │         │ Records │            │
│              └─────────┴─────────┴─────────┘            │
└─────────────────────────────────────────────────────────┘
                          ▲
            ┌─────────────┴─────────────┐
            │                           │
   ┌────────┴────────┐        ┌────────┴────────┐
   │  Admin App      │        │   User App      │
   │ (Ekiden_Admin)  │        │ (Ekiden_User)   │
   │                 │        │                 │
   │ 全機能          │        │ 閲覧・記録追加  │
   │ 管理者URL       │        │ 一般公開URL     │
   └─────────────────┘        └─────────────────┘
```

### コンポーネント詳細

#### データストア (Backend)
- **Google スプレッドシート**（単一ファイル）

#### Webアプリ①：管理者用 (Admin App)
| 項目 | 内容 |
|------|------|
| GASプロジェクト | Ekiden_Admin_App |
| 機能 | 全機能（閲覧、編集、削除、シミュレーション、一括登録） |
| アクセス権 | 管理者用URLを知っているユーザーのみ |

#### Webアプリ②：ユーザー用 (User App)
| 項目 | 内容 |
|------|------|
| GASプロジェクト | Ekiden_User_App |
| 機能 | 閲覧、自己記録追加、プロフィール編集（一部）、グラフ確認 |
| アクセス権 | 一般公開URLを知っているユーザー全員 |

#### フロントエンド
- HTML5 / CSS3 / JavaScript (Client-side)
- Google Apps Script HtmlService

#### 認証
- **なし**（Googleアカウントを持たないユーザーも利用可能にするため）
- セキュリティはURLの管理（管理者URLの秘匿）に依存する

---

## 4. 画面仕様

画面は「左ペイン（リスト）」「中央ペイン（詳細）」「右ペイン（記録）」の **3カラム構成** を基本とする。

```
┌──────────────┬─────────────────────────┬──────────────┐
│              │                         │              │
│  名簿リスト   │    プロフィール詳細      │   記録リスト  │
│  （左ペイン） │     （中央ペイン）       │  （右ペイン） │
│              │                         │              │
│  ・選手一覧   │  ・基本情報              │  ・大会記録   │
│  ・検索機能   │  ・目標設定              │    一覧      │
│              │  ・記録推移グラフ         │              │
│              │                         │              │
└──────────────┴─────────────────────────┴──────────────┘
```

### 4.1. 共通画面（ユーザー/管理者 共通）

#### 名簿リスト（左ペイン）
| 項目 | 内容 |
|------|------|
| 表示 | 選手一覧（登録番号、氏名、学年/カテゴリ） |
| 検索 | 氏名・所属・登録番号・カテゴリによるフィルタリング |
| 機能 | クリックで中央ペインに詳細を表示。ローディング表示あり |

#### プロフィール詳細（中央ペイン）
| 項目 | 内容 |
|------|------|
| 基本情報 | 登録番号、氏名、画像、所属、学年など |
| 目標設定 | 今シーズンの目標タイム（1500m/3000m/5000m/10000m/ハーフ/フル）と、自己ベストとの差分（「あと -5秒」等） |
| 記録推移グラフ | 過去の記録を折れ線グラフで視覚化（Chart.js使用） |

#### 記録リスト（右ペイン）
| 項目 | 内容 |
|------|------|
| 表示 | 選択した選手の大会記録一覧（日付降順） |

### 4.2. ユーザー機能（User App 専用UI）

#### プロフィール編集モーダル
- 自身の「目標タイム」「一言コメント」等の編集が可能

#### 個人記録追加フォーム
- レース結果（大会名、日付、種目、タイム）の投稿が可能

### 4.3. 管理者機能（Admin App 専用UI）

#### 選手追加・編集フォーム
- 新規選手の登録（登録番号含む）
- 既存情報の修正
- 削除、退部処理

#### チーム記録追加フォーム
- チーム全体の成績（大会名、順位、総合タイム）の登録

#### 区間オーダー シミュレーション画面
| 項目 | 内容 |
|------|------|
| UI | 左側に選手カード、右側に区間スロット（1区〜N区） |
| 操作 | ドラッグ＆ドロップで選手を配置 |
| 機能 | 配置した選手の持ちタイム合計（予想ゴールタイム）をリアルタイム計算・表示。シミュレーション案の保存・読込 |

#### CSV一括登録画面
- 選手データ（CSV）をアップロードし、DBへ一括追加する

---

## 5. データ仕様 (Googleスプレッドシート)

### 5.1. Players シート（選手マスタ）

| カラム名 | 論理名 | データ型 | 備考 |
|----------|--------|----------|------|
| id | 選手ID | String | UUID等、システム内部用 |
| registration_number | 登録番号 | String | (新規) ゼッケン番号や陸協登録番号 |
| name | 氏名 | String | |
| affiliation | 所属 | String | 学校名、チーム名 |
| category | 学年/カテゴリ | String | 中学生、一般、30代等 |
| target_1500m | 1500m目標 | String | "04:10" 等 |
| target_3000m | 3000m目標 | String | "09:00" 等 |
| target_5000m | 5000m目標 | String | "15:30" 等 |
| target_10000m | 10000m目標 | String | "32:00" 等 |
| target_half | ハーフ目標 | String | "1:10:00" 等 |
| target_full | フル目標 | String | "2:30:00" 等 |
| comment | 一言/備考 | String | |
| is_deleted | 削除フラグ | Boolean | 論理削除用 |

### 5.2. Records シート（個人記録）

| カラム名 | 論理名 | データ型 | 備考 |
|----------|--------|----------|------|
| record_id | 記録ID | String | |
| player_id | 選手ID | String | Playersシートと紐付け |
| race_name | 大会名 | String | |
| date | 開催日 | Date | |
| section | 区間/種目 | String | "1区", "3000m" 等 |
| time | 記録 | String | "09:15" 等 |
| memo | 備考 | String | |

### 5.3. TeamRecords シート（チーム記録）

| カラム名 | 論理名 | データ型 | 備考 |
|----------|--------|----------|------|
| team_record_id | ID | String | |
| race_name | 大会名 | String | |
| date | 開催日 | Date | |
| total_time | 総合記録 | String | |
| rank | 順位 | Number | |
| memo | 備考 | String | |

### 5.4. Simulations シート（シミュレーション保存）

| カラム名 | 論理名 | データ型 | 備考 |
|----------|--------|----------|------|
| sim_id | ID | String | |
| title | 案の名称 | String | "Aチーム案" 等 |
| created_at | 作成日 | Date | |
| order_json | オーダーデータ | JSON | `[{section:1, player_id: "xxx"}, ...]` |

---

## 6. 機能仕様

### 6.1. データ取得・表示系 (Common)

| 関数名 | 説明 |
|--------|------|
| `getPlayers()` | 削除フラグがFalseの全選手を取得。登録番号順または氏名順でソート |
| `getPlayerDetail(playerId)` | 特定選手の詳細情報および目標タイムを取得 |
| `getPlayerRecords(playerId)` | 特定選手の記録一覧を取得 |
| `getRecordHistory(playerId)` | グラフ描画用に、特定選手の記録を時系列データ（日付, 秒換算タイム）として取得 |
| `getTeamRecords()` | チームの過去成績一覧を取得 |

### 6.2. ユーザーアクション系 (User Role)

| 関数名 | 説明 |
|--------|------|
| `addPersonalRecord(data)` | 自身の記録を追加 |
| `updateProfile(data)` | 目標タイム、一言コメントの更新 |
| `calculateTargetDiff(bestTime, targetTime)` | 目標達成度（差分）の計算ロジック |

### 6.3. 管理者アクション系 (Admin Role)

| 関数名 | 説明 |
|--------|------|
| `addPlayer(data)` | 新規選手登録（登録番号必須） |
| `updatePlayer(data)` | 選手情報の修正（登録番号変更含む） |
| `deletePlayer(playerId)` | 選手を論理削除（フラグ更新） |
| `importPlayersFromCSV(csvContent)` | CSVを解析し、registration_number の重複を確認した上で一括登録 |
| `addTeamRecord(data)` | チーム成績の登録 |
| `saveSimulation(data)` | オーダー表の保存 |
| `loadSimulations()` | 保存済みオーダー表の呼び出し |

---

## 7. 非機能要件

### 性能

| 項目 | 要件 |
|------|------|
| 初期ロード | 2〜3秒以内 |
| 画面切り替え（詳細表示） | 1秒以内 |
| グラフ描画 | 非同期処理によりUIをブロックしない |

### 規模

| 項目 | 想定値 |
|------|--------|
| 選手数 | 約50〜100名程度 |
| 記録数 | 1人あたり最大300件程度 |

### UI/UX

| 項目 | 内容 |
|------|------|
| レスポンシブ | PC、タブレット、スマホで見崩れしないCSS設計（Flexbox/Grid使用） |

### ライブラリ

| 用途 | ライブラリ |
|------|-----------|
| グラフ | Chart.js（軽量・美麗） |
| D&D | SortableJS（シミュレーション用） |

### セキュリティ

| 項目 | 内容 |
|------|------|
| 認証なし | 誰でもアクセス可能なため、URL管理を徹底する |
| 管理者URL | 関係者外秘とし、SNS等への掲載を禁止する |

---

## 8. 運用フロー

### 初期セットアップ

1. スプレッドシート作成
2. GASプロジェクトを2つ（Admin/User）作成し、デプロイ

### シーズンイン（年度初め）

1. 管理者が新入部員リストをCSVで一括登録
2. 選手にURLを配布
3. 選手は各自スマホでアクセスし、目標タイムを設定

### 日常練習・記録会

1. レース後、選手（または管理者）が記録を追加
2. 自動的にグラフが更新され、成長を確認

### 駅伝大会前

1. 監督・コーチが管理者アプリでシミュレーションを実施
2. 「1区を〇〇、2区を△△にした場合の予想タイム」を算出
3. 最適なオーダーを決定

---

## 更新履歴

| 日付 | バージョン | 内容 |
|------|-----------|------|
| 2025-11-30 | Ver2.0 | 初版作成（完全版） |
