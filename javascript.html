<script>
// ===========================================
// åˆæœŸåŒ–
// ===========================================
document.addEventListener('DOMContentLoaded', function() {
  if (INITIAL_PLAYER_ID) {
    // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒšãƒ¼ã‚¸
    loadPlayerProfile(INITIAL_PLAYER_ID);
  } else {
    // é¸æ‰‹ä¸€è¦§ãƒšãƒ¼ã‚¸
    loadPlayers();
  }
});

// ===========================================
// é¸æ‰‹ä¸€è¦§
// ===========================================
function loadPlayers() {
  showLoading('playerList');

  google.script.run
    .withSuccessHandler(function(result) {
      if (result === null || result === undefined) {
        showToast('ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã®å¿œç­”ãŒã‚ã‚Šã¾ã›ã‚“', 'error');
        document.getElementById('playerList').innerHTML =
          '<div class="empty-state"><p>ã‚µãƒ¼ãƒãƒ¼å¿œç­”ã‚¨ãƒ©ãƒ¼</p></div>';
        return;
      }

      if (result.success) {
        playersData = result.data;
        renderPlayerList(playersData);
        updateFilters(playersData);
      } else {
        showToast(result.error || 'é¸æ‰‹ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
        document.getElementById('playerList').innerHTML =
          '<div class="empty-state"><p>ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</p></div>';
      }
    })
    .withFailureHandler(function(error) {
      showToast('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message, 'error');
      document.getElementById('playerList').innerHTML =
        '<div class="empty-state"><p>é€šä¿¡ã‚¨ãƒ©ãƒ¼</p></div>';
    })
    .getPlayers();
}

function renderPlayerList(players) {
  const container = document.getElementById('playerList');

  if (!players || players.length === 0) {
    container.innerHTML = '<div class="empty-state"><p>é¸æ‰‹ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</p></div>';
    return;
  }

  container.innerHTML = players.map(player => `
    <div class="player-card"
       data-id="${player.id}"
       data-name="${player.name}"
       data-category="${player.category || ''}"
       data-affiliation="${player.affiliation || ''}"
       onclick="navigateToProfile('${player.id}')"
       style="cursor: pointer;">
      <div class="player-card-number">${player.registration_number || '-'}</div>
      <div class="player-card-name">${player.name}</div>
      <div class="player-card-info">
        <span>${player.affiliation || '-'}</span>
        <span>${player.category || '-'}</span>
      </div>
    </div>
  `).join('');
}

// ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒšãƒ¼ã‚¸ã¸ã®é·ç§»
function navigateToProfile(playerId) {
  const url = BASE_URL + '?pid=' + playerId + '&mode=' + APP_MODE;
  navigateTo(url);
}

// é¸æ‰‹ä¸€è¦§ãƒšãƒ¼ã‚¸ã¸ã®é·ç§»
function navigateToList() {
  const url = BASE_URL + '?mode=' + APP_MODE;
  navigateTo(url);
}

// ãƒšãƒ¼ã‚¸é·ç§»ï¼ˆiframeå¯¾å¿œï¼‰
function navigateTo(url) {
  // iframeå†…ã§ã‚‚å‹•ä½œã™ã‚‹ã‚ˆã†ã«è¤‡æ•°ã®æ–¹æ³•ã‚’è©¦ã™
  try {
    window.top.location.href = url;
  } catch (e) {
    // ã‚¯ãƒ­ã‚¹ã‚ªãƒªã‚¸ãƒ³ã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯ç¾åœ¨ã®ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã§é·ç§»
    window.location.href = url;
  }
}

// ===========================================
// ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒšãƒ¼ã‚¸
// ===========================================
let currentPlayerData = null; // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒšãƒ¼ã‚¸ç”¨ã®é¸æ‰‹ãƒ‡ãƒ¼ã‚¿

function loadPlayerProfile(playerId) {
  currentPlayerId = playerId;

  // é¸æ‰‹è©³ç´°ã‚’èª­ã¿è¾¼ã¿
  google.script.run
    .withSuccessHandler(function(result) {
      if (result && result.success) {
        currentPlayerData = result.data;
        renderPlayerProfileCard(result.data);
        renderPersonalBests(result.data);
      } else {
        document.getElementById('playerProfileCard').innerHTML =
          '<div class="empty-state"><p>é¸æ‰‹æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</p></div>';
      }
    })
    .withFailureHandler(function(error) {
      showToast('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message, 'error');
      document.getElementById('playerProfileCard').innerHTML =
        '<div class="empty-state"><p>é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</p></div>';
    })
    .getPlayerDetail(playerId);

  // è¨˜éŒ²ã‚’èª­ã¿è¾¼ã¿
  loadPlayerRecordsForProfile(playerId);
}

function updateFilters(players) {
  // ã‚«ãƒ†ã‚´ãƒªãƒ•ã‚£ãƒ«ã‚¿
  const categories = [...new Set(players.map(p => p.category).filter(c => c))];
  const categorySelect = document.getElementById('categoryFilter');
  categorySelect.innerHTML = '<option value="">å…¨ã‚«ãƒ†ã‚´ãƒª</option>' +
    categories.map(c => `<option value="${c}">${c}</option>`).join('');

  // æ‰€å±ãƒ•ã‚£ãƒ«ã‚¿
  const affiliations = [...new Set(players.map(p => p.affiliation).filter(a => a))];
  const affiliationSelect = document.getElementById('affiliationFilter');
  affiliationSelect.innerHTML = '<option value="">å…¨æ‰€å±</option>' +
    affiliations.map(a => `<option value="${a}">${a}</option>`).join('');
}

function filterPlayers() {
  const searchText = document.getElementById('searchInput').value.toLowerCase();
  const categoryFilter = document.getElementById('categoryFilter').value;
  const affiliationFilter = document.getElementById('affiliationFilter').value;

  const filtered = playersData.filter(player => {
    const matchesSearch = !searchText ||
      player.name.toLowerCase().includes(searchText) ||
      (player.registration_number && player.registration_number.toLowerCase().includes(searchText)) ||
      (player.affiliation && player.affiliation.toLowerCase().includes(searchText));

    const matchesCategory = !categoryFilter || player.category === categoryFilter;
    const matchesAffiliation = !affiliationFilter || player.affiliation === affiliationFilter;

    return matchesSearch && matchesCategory && matchesAffiliation;
  });

  renderPlayerList(filtered);
}

// ===========================================
// é¸æ‰‹è©³ç´°ï¼ˆæ—§ã‚¹ã‚¿ã‚¤ãƒ« - äº’æ›ç”¨ï¼‰
// ===========================================
function selectPlayer(playerId) {
  currentPlayerId = playerId;

  // ãƒªã‚¹ãƒˆã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã‚’æ›´æ–°
  document.querySelectorAll('.player-item').forEach(item => {
    item.classList.toggle('active', item.dataset.id === playerId);
  });

  // è©³ç´°ã‚’èª­ã¿è¾¼ã¿
  showLoading('playerDetail');
  const addRecordBtn = document.getElementById('addRecordBtn');
  if (addRecordBtn) addRecordBtn.style.display = 'inline-flex';

  google.script.run
    .withSuccessHandler(function(result) {
      if (result.success) {
        renderPlayerDetail(result.data);
        loadPlayerRecords(playerId);
      } else {
        showToast(result.error || 'é¸æ‰‹æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
      }
    })
    .withFailureHandler(function(error) {
      showToast('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message, 'error');
    })
    .getPlayerDetail(playerId);
}

// ===========================================
// ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚«ãƒ¼ãƒ‰ï¼ˆãƒ¢ãƒ€ãƒ³ãƒ‡ã‚¶ã‚¤ãƒ³ï¼‰
// ===========================================
function renderPlayerProfileCard(player) {
  const container = document.getElementById('playerProfileCard');

  const adminButtons = APP_MODE === 'admin' ? `
    <button class="btn btn-outline btn-sm" onclick="showEditPlayerModal('${player.id}')">ç·¨é›†</button>
    <button class="btn btn-danger btn-sm" onclick="confirmDeletePlayer('${player.id}')">å‰Šé™¤</button>
  ` : `
    <button class="btn btn-outline btn-sm" onclick="showProfileModal('${player.id}')">ç›®æ¨™ç·¨é›†</button>
  `;

  container.innerHTML = `
    <div class="profile-header-section">
      <div class="profile-photo">ğŸ‘¤</div>
      <div class="profile-main-info">
        <div class="profile-name">${player.name}</div>
        <div class="profile-name-sub">${player.registration_number || ''}</div>
        <div class="profile-tags">
          ${player.category ? `<span class="profile-tag">${player.category}</span>` : ''}
          ${player.affiliation ? `<span class="profile-tag primary">${player.affiliation}</span>` : ''}
        </div>
      </div>
    </div>

    <div class="profile-divider"></div>

    <div class="profile-info-grid">
      <div class="profile-info-item">
        <span class="profile-info-label">ç™»éŒ²ç•ªå·</span>
        <span class="profile-info-value">${player.registration_number || '-'}</span>
      </div>
      <div class="profile-info-item">
        <span class="profile-info-label">ã‚«ãƒ†ã‚´ãƒª</span>
        <span class="profile-info-value">${player.category || '-'}</span>
      </div>
      <div class="profile-info-item full-width">
        <span class="profile-info-label">æ‰€å±</span>
        <span class="profile-info-value">${player.affiliation || '-'}</span>
      </div>
    </div>

    <div class="profile-actions">
      ${adminButtons}
    </div>
  `;

  // ã‚³ãƒ¡ãƒ³ãƒˆã‚«ãƒ¼ãƒ‰ã‚’è¡¨ç¤º
  if (player.comment) {
    document.getElementById('playerCommentCard').style.display = 'block';
    document.getElementById('playerComment').textContent = player.comment;
  } else {
    document.getElementById('playerCommentCard').style.display = 'none';
  }
}

function renderPersonalBests(player) {
  const targets = [
    { key: 'target_1500m', label: '1500m' },
    { key: 'target_3000m', label: '3000m' },
    { key: 'target_5000m', label: '5000m' },
    { key: 'target_10000m', label: '10000m' },
    { key: 'target_half', label: 'ãƒãƒ¼ãƒ•' },
    { key: 'target_full', label: 'ãƒ•ãƒ«' }
  ];

  const hasTargets = targets.some(t => player[t.key]);

  if (!hasTargets) {
    document.getElementById('personalBestsCard').style.display = 'none';
    return;
  }

  document.getElementById('personalBestsCard').style.display = 'block';

  const pbItems = targets
    .filter(t => player[t.key])
    .map(t => {
      const targetTime = player[t.key];
      const bestRecord = player.bestRecords ? player.bestRecords[t.label] : null;

      return `
        <div class="pb-item">
          <div class="pb-event">${t.label}</div>
          <div class="pb-time">${targetTime}</div>
          ${bestRecord ? `<div class="pb-date">PB: ${bestRecord.time}</div>` : '<div class="pb-date">ç›®æ¨™ã‚¿ã‚¤ãƒ </div>'}
        </div>
      `;
    }).join('');

  document.getElementById('personalBests').innerHTML = pbItems;
}

function loadPlayerRecordsForProfile(playerId) {
  const container = document.getElementById('recordsTableContainer');
  container.innerHTML = '<div class="loading">èª­ã¿è¾¼ã¿ä¸­...</div>';

  google.script.run
    .withSuccessHandler(function(result) {
      if (result.success) {
        renderRecordsTable(result.data);
        renderCareerStats(result.data);
      } else {
        container.innerHTML = '<div class="empty-state"><p>è¨˜éŒ²ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</p></div>';
      }
    })
    .withFailureHandler(function(error) {
      console.error('è¨˜éŒ²å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
      container.innerHTML = '<div class="empty-state"><p>é€šä¿¡ã‚¨ãƒ©ãƒ¼</p></div>';
    })
    .getPlayerRecords(playerId);
}

function renderRecordsTable(records) {
  const container = document.getElementById('recordsTableContainer');

  if (!records || records.length === 0) {
    container.innerHTML = '<div class="empty-state"><p>è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</p></div>';
    return;
  }

  const tableRows = records.map(record => {
    const dateStr = record.date ? formatDateStr(record.date) : '-';
    const year = record.date ? new Date(record.date).getFullYear() : '-';

    return `
      <tr>
        <td class="year-cell">${year}</td>
        <td class="race-name">${record.race_name || '-'}</td>
        <td class="section-cell">${record.section || '-'}</td>
        <td class="time-cell">${record.time || '-'}</td>
      </tr>
    `;
  }).join('');

  container.innerHTML = `
    <table class="records-table">
      <thead>
        <tr>
          <th>å¹´åº¦</th>
          <th>å¤§ä¼š</th>
          <th>ç¨®ç›®</th>
          <th>è¨˜éŒ²</th>
        </tr>
      </thead>
      <tbody>
        ${tableRows}
      </tbody>
    </table>
  `;
}

function renderCareerStats(records) {
  const statsCard = document.getElementById('careerStatsCard');

  if (!records || records.length === 0) {
    statsCard.style.display = 'none';
    return;
  }

  statsCard.style.display = 'block';

  // å‡ºå ´å›æ•°
  const totalRaces = records.length;

  // ç¨®ç›®åˆ¥è¨˜éŒ²æ•°ï¼ˆé§…ä¼åŒºé–“ã®ã¿ï¼‰
  const ekidenSections = ['1åŒº', '2åŒº', '3åŒº', '4åŒº', '5åŒº', '6åŒº'];
  const ekidenCount = records.filter(r => ekidenSections.includes(r.section)).length;

  // æœ€æ–°è¨˜éŒ²ã®å¹´
  const years = records.map(r => r.date ? new Date(r.date).getFullYear() : 0).filter(y => y > 0);
  const latestYear = years.length > 0 ? Math.max(...years) : '-';

  document.getElementById('careerStats').innerHTML = `
    <div class="stats-item">
      <div class="stats-number">${totalRaces}<span class="unit">å›</span></div>
      <div class="stats-label">è¨˜éŒ²æ•°</div>
    </div>
    <div class="stats-item">
      <div class="stats-number">${ekidenCount}<span class="unit">å›</span></div>
      <div class="stats-label">é§…ä¼å‡ºå ´</div>
    </div>
    <div class="stats-item">
      <div class="stats-number">${latestYear}</div>
      <div class="stats-label">æœ€æ–°è¨˜éŒ²</div>
    </div>
  `;
}

// ===========================================
// é¸æ‰‹è©³ç´°ï¼ˆæ—§ã‚¹ã‚¿ã‚¤ãƒ« - äº’æ›ç”¨ï¼‰
// ===========================================
function renderPlayerDetail(player) {
  const container = document.getElementById('playerDetail');
  if (!container) return;

  const targets = [
    { key: 'target_1500m', label: '1500m' },
    { key: 'target_3000m', label: '3000m' },
    { key: 'target_5000m', label: '5000m' },
    { key: 'target_10000m', label: '10000m' },
    { key: 'target_half', label: 'ãƒãƒ¼ãƒ•' },
    { key: 'target_full', label: 'ãƒ•ãƒ«' }
  ];

  const targetCards = targets.map(t => {
    const targetTime = player[t.key];
    const bestRecord = player.bestRecords ? player.bestRecords[t.label] : null;

    let diffHtml = '';
    if (targetTime && bestRecord) {
      const diff = calculateDiff(bestRecord.time, targetTime);
      diffHtml = `<div class="target-card-diff ${diff.achieved ? 'achieved' : 'pending'}">${diff.message}</div>`;
    }

    return `
      <div class="target-card">
        <div class="target-card-label">${t.label}</div>
        <div class="target-card-value">${targetTime || '-'}</div>
        ${bestRecord ? `<div class="target-card-label">PB: ${bestRecord.time}</div>` : ''}
        ${diffHtml}
      </div>
    `;
  }).join('');

  const adminButtons = APP_MODE === 'admin' ? `
    <button class="btn btn-outline btn-sm" onclick="showEditPlayerModal('${player.id}')">ç·¨é›†</button>
    <button class="btn btn-danger btn-sm" onclick="confirmDeletePlayer('${player.id}')">å‰Šé™¤</button>
  ` : `
    <button class="btn btn-outline btn-sm" onclick="showProfileModal('${player.id}')">ç›®æ¨™ç·¨é›†</button>
  `;

  container.innerHTML = `
    <div class="detail-header">
      <div>
        <div class="detail-name">${player.name}</div>
        <div class="detail-meta">
          <span>No. ${player.registration_number || '-'}</span>
          <span>${player.affiliation || '-'}</span>
          <span>${player.category || '-'}</span>
        </div>
      </div>
      <div class="detail-actions">
        ${adminButtons}
      </div>
    </div>

    <div class="detail-section">
      <h3>ç›®æ¨™ã‚¿ã‚¤ãƒ </h3>
      <div class="target-grid">
        ${targetCards}
      </div>
    </div>

    ${player.comment ? `
    <div class="detail-section">
      <h3>ã‚³ãƒ¡ãƒ³ãƒˆ</h3>
      <p>${player.comment}</p>
    </div>
    ` : ''}

    <div class="detail-section">
      <h3>è¨˜éŒ²æ¨ç§»ã‚°ãƒ©ãƒ•</h3>
      <div class="chart-controls">
        <select id="chartSection" onchange="updateChart()">
          <option value="">å…¨ç¨®ç›®</option>
          <option value="1500m">1500m</option>
          <option value="3000m">3000m</option>
          <option value="5000m">5000m</option>
          <option value="10000m">10000m</option>
          <option value="ãƒãƒ¼ãƒ•">ãƒãƒ¼ãƒ•</option>
          <option value="ãƒ•ãƒ«">ãƒ•ãƒ«</option>
        </select>
      </div>
      <div class="chart-container">
        <canvas id="recordChart"></canvas>
      </div>
    </div>
  `;

  // ã‚°ãƒ©ãƒ•ã‚’åˆæœŸåŒ–
  loadRecordChart(player.id);
}

function calculateDiff(bestTime, targetTime) {
  const toSeconds = (timeStr) => {
    if (!timeStr) return null;
    const parts = timeStr.split(':').map(Number);
    if (parts.length === 3) return parts[0] * 3600 + parts[1] * 60 + parts[2];
    if (parts.length === 2) return parts[0] * 60 + parts[1];
    return null;
  };

  const bestSec = toSeconds(bestTime);
  const targetSec = toSeconds(targetTime);

  if (bestSec === null || targetSec === null) return { achieved: false, message: '' };

  const diff = bestSec - targetSec;
  const absDiff = Math.abs(diff);
  const mins = Math.floor(absDiff / 60);
  const secs = absDiff % 60;
  const diffStr = mins > 0 ? `${mins}:${String(secs).padStart(2, '0')}` : `${secs}ç§’`;

  if (diff <= 0) {
    return { achieved: true, message: 'ç›®æ¨™é”æˆ!' };
  } else {
    return { achieved: false, message: `ã‚ã¨ ${diffStr}` };
  }
}

// ===========================================
// è¨˜éŒ²ä¸€è¦§
// ===========================================
function loadPlayerRecords(playerId) {
  showLoading('recordList');

  google.script.run
    .withSuccessHandler(function(result) {
      if (result.success) {
        renderRecordList(result.data);
      }
    })
    .withFailureHandler(function(error) {
      console.error('è¨˜éŒ²å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
    })
    .getPlayerRecords(playerId);
}

function renderRecordList(records) {
  const container = document.getElementById('recordList');

  if (!records || records.length === 0) {
    container.innerHTML = '<div class="empty-state"><p>è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</p></div>';
    return;
  }

  container.innerHTML = records.map(record => {
    const dateStr = record.date ? formatDateStr(record.date) : '-';
    return `
      <div class="record-item">
        <div class="record-item-header">
          <span class="record-item-date">${dateStr}</span>
          <span class="record-item-time">${record.time || '-'}</span>
        </div>
        <div class="record-item-race">${record.race_name || '-'}</div>
        <span class="record-item-section">${record.section || '-'}</span>
        ${record.memo ? `<div style="font-size:0.8rem;color:#666;margin-top:0.25rem;">${record.memo}</div>` : ''}
      </div>
    `;
  }).join('');
}

function formatDateStr(date) {
  if (!date) return '';
  const d = new Date(date);
  if (isNaN(d.getTime())) return date;
  return `${d.getFullYear()}/${String(d.getMonth() + 1).padStart(2, '0')}/${String(d.getDate()).padStart(2, '0')}`;
}

// ===========================================
// ã‚°ãƒ©ãƒ•
// ===========================================
function loadRecordChart(playerId, section) {
  google.script.run
    .withSuccessHandler(function(result) {
      if (result.success && result.data) {
        renderChart(result.data);
      }
    })
    .getRecordHistory(playerId, section || '');
}

function renderChart(chartData) {
  const ctx = document.getElementById('recordChart');
  if (!ctx) return;

  // æ—¢å­˜ã®ãƒãƒ£ãƒ¼ãƒˆã‚’ç ´æ£„
  if (recordChart) {
    recordChart.destroy();
  }

  const datasets = [];
  const colors = [
    '#4a86e8', '#ea4335', '#34a853', '#fbbc04', '#9334e8', '#e84a8a'
  ];

  let colorIndex = 0;
  for (const section in chartData.datasets) {
    const data = chartData.datasets[section];
    datasets.push({
      label: section,
      data: data.map(d => ({ x: d.x, y: d.y })),
      borderColor: colors[colorIndex % colors.length],
      backgroundColor: colors[colorIndex % colors.length] + '20',
      tension: 0.1,
      fill: false
    });
    colorIndex++;
  }

  if (datasets.length === 0) {
    return;
  }

  recordChart = new Chart(ctx, {
    type: 'line',
    data: { datasets },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        x: {
          type: 'category',
          title: { display: true, text: 'æ—¥ä»˜' }
        },
        y: {
          title: { display: true, text: 'è¨˜éŒ²ï¼ˆç§’ï¼‰' },
          reverse: true, // è¨˜éŒ²ã¯å°‘ãªã„ã»ã†ãŒè‰¯ã„ã®ã§é€†é †
          ticks: {
            callback: function(value) {
              const mins = Math.floor(value / 60);
              const secs = value % 60;
              return `${mins}:${String(secs).padStart(2, '0')}`;
            }
          }
        }
      },
      plugins: {
        tooltip: {
          callbacks: {
            label: function(context) {
              const point = chartData.datasets[context.dataset.label][context.dataIndex];
              return `${context.dataset.label}: ${point.time} (${point.race_name})`;
            }
          }
        }
      }
    }
  });
}

function updateChart() {
  const section = document.getElementById('chartSection').value;
  if (currentPlayerId) {
    loadRecordChart(currentPlayerId, section);
  }
}

// ===========================================
// ãƒ¢ãƒ¼ãƒ€ãƒ«
// ===========================================
function openModal(modalId) {
  document.getElementById(modalId).classList.add('active');
}

function closeModal(modalId) {
  document.getElementById(modalId).classList.remove('active');
}

function showAddPlayerModal() {
  document.getElementById('playerModalTitle').textContent = 'é¸æ‰‹è¿½åŠ ';
  document.getElementById('playerForm').reset();
  document.getElementById('playerId').value = '';
  openModal('playerModal');
}

function showEditPlayerModal(playerId) {
  document.getElementById('playerModalTitle').textContent = 'é¸æ‰‹ç·¨é›†';

  // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒšãƒ¼ã‚¸ã§ã¯currentPlayerDataã‚’ã€ä¸€è¦§ãƒšãƒ¼ã‚¸ã§ã¯playersDataã‚’ä½¿ç”¨
  const player = currentPlayerData && currentPlayerData.id === playerId
    ? currentPlayerData
    : playersData.find(p => p.id === playerId);

  if (!player) return;

  document.getElementById('playerId').value = player.id;
  document.getElementById('registrationNumber').value = player.registration_number || '';
  document.getElementById('playerName').value = player.name || '';
  document.getElementById('affiliation').value = player.affiliation || '';
  document.getElementById('category').value = player.category || '';
  document.getElementById('target1500m').value = player.target_1500m || '';
  document.getElementById('target3000m').value = player.target_3000m || '';
  document.getElementById('target5000m').value = player.target_5000m || '';
  document.getElementById('target10000m').value = player.target_10000m || '';
  document.getElementById('targetHalf').value = player.target_half || '';
  document.getElementById('targetFull').value = player.target_full || '';
  document.getElementById('comment').value = player.comment || '';

  openModal('playerModal');
}

function showAddRecordModal() {
  if (!currentPlayerId) {
    showToast('é¸æ‰‹ã‚’é¸æŠã—ã¦ãã ã•ã„', 'error');
    return;
  }

  document.getElementById('recordForm').reset();
  document.getElementById('recordPlayerId').value = currentPlayerId;
  document.getElementById('raceDate').value = new Date().toISOString().split('T')[0];
  openModal('recordModal');
}

function showProfileModal(playerId) {
  // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒšãƒ¼ã‚¸ã§ã¯currentPlayerDataã‚’ã€ä¸€è¦§ãƒšãƒ¼ã‚¸ã§ã¯playersDataã‚’ä½¿ç”¨
  const player = currentPlayerData && currentPlayerData.id === playerId
    ? currentPlayerData
    : playersData.find(p => p.id === playerId);

  if (!player) return;

  document.getElementById('profilePlayerId').value = player.id;
  document.getElementById('profileTarget1500m').value = player.target_1500m || '';
  document.getElementById('profileTarget3000m').value = player.target_3000m || '';
  document.getElementById('profileTarget5000m').value = player.target_5000m || '';
  document.getElementById('profileTarget10000m').value = player.target_10000m || '';
  document.getElementById('profileTargetHalf').value = player.target_half || '';
  document.getElementById('profileTargetFull').value = player.target_full || '';
  document.getElementById('profileComment').value = player.comment || '';

  openModal('profileModal');
}

// ===========================================
// ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡
// ===========================================
function submitPlayerForm(event) {
  event.preventDefault();

  const formData = new FormData(event.target);
  const data = Object.fromEntries(formData.entries());

  const isEdit = !!data.id;
  const apiFunc = isEdit ? 'updatePlayer' : 'addPlayer';

  google.script.run
    .withSuccessHandler(function(result) {
      if (result.success) {
        showToast(isEdit ? 'é¸æ‰‹æƒ…å ±ã‚’æ›´æ–°ã—ã¾ã—ãŸ' : 'é¸æ‰‹ã‚’è¿½åŠ ã—ã¾ã—ãŸ', 'success');
        closeModal('playerModal');

        // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒšãƒ¼ã‚¸ã®å ´åˆã¯ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’å†èª­ã¿è¾¼ã¿
        if (INITIAL_PLAYER_ID && isEdit) {
          loadPlayerProfile(INITIAL_PLAYER_ID);
        } else {
          loadPlayers();
        }
      } else {
        showToast(result.error || 'ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
      }
    })
    .withFailureHandler(function(error) {
      showToast('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message, 'error');
    })
    [apiFunc](data);
}

function submitRecordForm(event) {
  event.preventDefault();

  const formData = new FormData(event.target);
  const data = Object.fromEntries(formData.entries());

  google.script.run
    .withSuccessHandler(function(result) {
      if (result.success) {
        showToast('è¨˜éŒ²ã‚’è¿½åŠ ã—ã¾ã—ãŸ', 'success');
        closeModal('recordModal');

        // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒšãƒ¼ã‚¸ã®å ´åˆã¯è©³ç´°ã¨è¨˜éŒ²ã‚’å†èª­ã¿è¾¼ã¿
        if (INITIAL_PLAYER_ID) {
          loadPlayerProfile(INITIAL_PLAYER_ID);
        } else {
          loadPlayerRecords(currentPlayerId);
          selectPlayer(currentPlayerId);
        }
      } else {
        showToast(result.error || 'è¨˜éŒ²ã®è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
      }
    })
    .withFailureHandler(function(error) {
      showToast('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message, 'error');
    })
    .addPersonalRecord(data);
}

function submitProfileForm(event) {
  event.preventDefault();

  const formData = new FormData(event.target);
  const data = Object.fromEntries(formData.entries());

  google.script.run
    .withSuccessHandler(function(result) {
      if (result.success) {
        showToast('ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’æ›´æ–°ã—ã¾ã—ãŸ', 'success');
        closeModal('profileModal');

        // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒšãƒ¼ã‚¸ã®å ´åˆã¯ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’å†èª­ã¿è¾¼ã¿
        if (INITIAL_PLAYER_ID) {
          loadPlayerProfile(INITIAL_PLAYER_ID);
        } else {
          loadPlayers();
          selectPlayer(data.player_id);
        }
      } else {
        showToast(result.error || 'æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
      }
    })
    .withFailureHandler(function(error) {
      showToast('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message, 'error');
    })
    .updateProfile(data);
}

// ===========================================
// å‰Šé™¤
// ===========================================
function confirmDeletePlayer(playerId) {
  if (!confirm('ã“ã®é¸æ‰‹ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) {
    return;
  }

  google.script.run
    .withSuccessHandler(function(result) {
      if (result.success) {
        showToast('é¸æ‰‹ã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 'success');

        // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒšãƒ¼ã‚¸ã®å ´åˆã¯ä¸€è¦§ãƒšãƒ¼ã‚¸ã«æˆ»ã‚‹
        if (INITIAL_PLAYER_ID) {
          navigateToList();
        } else {
          currentPlayerId = null;
          loadPlayers();
          document.getElementById('playerDetail').innerHTML =
            '<div class="empty-state"><p>å·¦ã®ä¸€è¦§ã‹ã‚‰é¸æ‰‹ã‚’é¸æŠã—ã¦ãã ã•ã„</p></div>';
          document.getElementById('recordList').innerHTML =
            '<div class="empty-state"><p>é¸æ‰‹ã‚’é¸æŠã™ã‚‹ã¨è¨˜éŒ²ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</p></div>';
          const addRecordBtn = document.getElementById('addRecordBtn');
          if (addRecordBtn) addRecordBtn.style.display = 'none';
        }
      } else {
        showToast(result.error || 'å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
      }
    })
    .withFailureHandler(function(error) {
      showToast('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message, 'error');
    })
    .deletePlayer(playerId);
}

// ===========================================
// ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
// ===========================================
function showLoading(elementId) {
  document.getElementById(elementId).innerHTML = '<div class="loading">èª­ã¿è¾¼ã¿ä¸­...</div>';
}

function showToast(message, type = 'info') {
  const container = document.getElementById('toastContainer');
  const toast = document.createElement('div');
  toast.className = `toast ${type}`;
  toast.textContent = message;
  container.appendChild(toast);

  setTimeout(() => {
    toast.remove();
  }, 4000);
}
</script>
